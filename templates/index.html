<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookCocktail Mixologist</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>BookCocktail Mixologist 🍸</h1>
    <form id="cocktail-form">
        <input type="text" id="book-title-input" name="book_title" placeholder="書籍のタイトルを入力..." required>
        <button type="submit">カクテルを注文</button>
    </form>

    <!-- ローディング表示用の要素 -->
    <div id="loading" class="hidden">
        <div class="spinner"></div>
        <p>最高のカクテルをシェイク中です...</p>
    </div>

    <!-- 結果表示用のコンテナ -->
    <div id="result-container"></div>

    <script>
        const form = document.getElementById('cocktail-form');
        const input = document.getElementById('book-title-input');
        const loadingDiv = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');

        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // フォームのデフォルト送信をキャンセル

            const bookTitle = input.value;
            if (!bookTitle) return;

            // ローディング表示を開始
            loadingDiv.classList.remove('hidden');
            resultContainer.innerHTML = ''; // 前回の結果をクリア

            try {
                const response = await fetch('/generate-for-web', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ book_title: bookTitle }),
                });

                if (!response.ok) {
                    throw new Error(`サーバーエラー: ${response.statusText}`);
                }

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                console.error('Fetch error:', error);
                resultContainer.innerHTML = `<p class="error-message">エラーが発生しました: ${error.message}</p>`;
            } finally {
                // ローディング表示を終了
                loadingDiv.classList.add('hidden');
            }
        });

        function displayResults(data) {
            if (data.error) {
                resultContainer.innerHTML = `<p class="error-message">${data.error}</p>`;
                return;
            }

            // ヘルパー関数: ソースのセクションを生成
            const createSourceSection = (title, icon, sourceData) => {
                let content = '<p>関連情報が見つかりませんでした。</p>';
                if (sourceData && sourceData.url) {
                    content = `
                        <a href="${sourceData.url}" target="_blank">${sourceData.title}</a>
                        <p>→ 解説: ${sourceData.commentary}</p>
                    `;
                }
                return `
                    <div class="section">
                        <h3>${icon} ${title}</h3>
                        ${content}
                    </div>
                `;
            };

            const resultHTML = `
                <div class="cocktail-result">
                    <h2>『${data.book_title}』</h2>
                    <div class="section">
                        <h3>■ 作品の要約</h3>
                        <p>${data.summary}</p>
                    </div>
                    <hr>
                    ${createSourceSection('相補的な一杯', '🍷', data.complementary)}
                    ${createSourceSection('対照的な一杯', '🍋', data.contrasting)}
                    ${createSourceSection('意外な一杯', '🧂', data.tangent)}
                    <div class="section">
                        <h3 class="final-twist">🎭 最後の一ひねり</h3>
                        <p class="final-twist">「${data.twist}」</p>
                    </div>
                </div>
            `;
            resultContainer.innerHTML = resultHTML;
        }
    </script>
</body>
</html>
